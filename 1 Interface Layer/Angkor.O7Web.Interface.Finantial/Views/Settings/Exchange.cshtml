
@{
    ViewBag.Title = "Tipo de cambio";
    ViewBag.Section = "Configuración";
    Layout = "~/Views/_Layout.cshtml";
}

@section styles_link {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.13/css/dataTables.bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.2.4/css/buttons.dataTables.min.css" />

    @Html.StyleLink("css/bootstrap.min.css");
    @Html.StyleLink("font-awesome/css/font-awesome.css");
    @Html.StyleLink("css/plugins/iCheck/custom.css");
    @Html.StyleLink("css/plugins/steps/jquery.steps.css");
    @Html.StyleLink("css/animate.css");
    @Html.StyleLink("css/style.css");

    @Html.StyleLink("css/plugins/chosen/bootstrap-chosen.css");
    @Html.StyleLink("css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css");

    @Html.StyleLink("css/plugins/sweetalert/sweetalert.css")
    <style type="text/css">
        body {
            padding-right: 0 !important;
        }

        .form-separation {
            margin-bottom: 7px;
            margin-top: 7px;
        }

        .form-label-separation {
            margin-bottom: 10px;
            margin-top: 7px;
        }

        .form-separation-extra {
            margin-bottom: 11px;
        }

        .dataTables_filter {
            width: 50%;
            float: right;
            text-align: right;
        }

        .button-separation {
            margin-left: 12px;
            margin-right: 12px;
        }

        .selected {
            background-color: #acbad4 !important;
        }

        .emulate-label {
            border-left: 0 !important;
            border-right: 0 !important;
            border-top: 0 !important;
            background: #eee !important;
        }

        .labe-sum-underline {
            border-bottom: 3px solid #000000 !important;
        }

        .modal-new-width {
            width: 800px !important;
        }

        .tabIcon:before {
            content: "\f192";
            margin-right: 5px;
        }

        .tabIcon {
            padding: 10px 20px !important;
        }
    </style>
}
@section scripts_link {
    <script src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.13/js/dataTables.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.2.4/js/dataTables.buttons.min.js"></script>

    @Html.JavaScriptLink("js/jquery-2.1.1.js")
    @Html.JavaScriptLink("js/bootstrap.min.js")
    @Html.JavaScriptLink("js/plugins/metisMenu/jquery.metisMenu.js")
    @Html.JavaScriptLink("js/plugins/slimscroll/jquery.slimscroll.min.js")

    <!-- Custom and plugin javascript -->
    @Html.JavaScriptLink("js/inspinia.js")
    @Html.JavaScriptLink("js/plugins/pace/pace.min.js")

    <!-- Steps -->
    @Html.JavaScriptLink("js/plugins/staps/jquery.steps.min.js")

    <!-- Jquery Validate -->
    @Html.JavaScriptLink("js/plugins/validate/jquery.validate.min.js")

    @Html.JavaScriptLink("js/plugins/dataTables/datatables.min.js")
    @Html.JavaScriptLink("js/plugins/iCheck/icheck.min.js")

    @Html.JavaScriptLink("js/plugins/datapicker/bootstrap-datepicker.js")
    @Html.JavaScriptLink("js/plugins/chosen/chosen.jquery.js")
    @Html.JavaScriptLink("js/plugins/typehead/bootstrap3-typeahead.min.js")

    @Html.JavaScriptLink("js/plugins/sweetalert/sweetalert.min.js")
    @Html.JavaScriptLink("js/plugins/jquery-maskedinput/jquery.maskedinput.js")

}

@section section_script {
    var tableExchanges;
    var array_exchanges;

    tableExchanges = $('#tableExchanges').DataTable({
        "bPaginate": false,
        "bLengthChange": false,
        "bFilter": false,
        "bInfo": false,
        "bAutoWidth": false,
        "paging": false,
        "columns": [{
            data: "edit",
            width: "1%",
            title: ""
        },
        {
            data: "delete",
            width: "1%",
            title: ""
        },
        {
            data: "date",
            title: "Fecha"
        },
        {
            data: "monOri",
            title: "Mes origen"
        },
        {
            data: "monFin",
            title: "Mes fin"
        },
        {
            data: "valCom",
            title: "Valor de compra"
        },
        {
            data: "valVen",
            title: "Valor de venta"
        }]
    });

    function drawTableGrid(){
        if (tableExchanges != null){
            tableExchanges.clear().draw();
        }
        loadTable();
    }

    function DeleteExchange(data){
        $.ajax({
            method: "POST",
            url: "/Finantial/Settings/DeleteExchange",
            data: data
        })
        .done(drawTableGrid())
        .fail(function(result) {
            toastr.error(result.statusText, "Mensaje", {
                positionClass: "toast-top-full-width"
            });
        });
    }

    $('#btnAgregar').click(function(){
        $("#txtModalTitle").text("Crear");
        $('#editModal').attr('action', '/Finantial/Settings/CreateExchange');
        $('#editModal').modal('show');
    });

    function btn_delete_click() {
        var btn_id = $(this).attr('id');
        var btn_id_split = btn_id.split('_');
        var id = btn_id_split[1];

        var exchange = table_contents[id];

        var data = {
            date: exchange.date,
            monOri: exchange.monOri
        }

        swal({
            title: "Confirmación",
            text: "¿Desea eliminar el registro?",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "Sí",
            closeOnConfirm: false
        }, DeleteExchange(data));
    }

    function btn_edit_click() {
        $("#txtModalTitle").text("Editar");
        $('#editModal').attr('action', '/Finantial/Settings/UpdateExchange');
        
        var btn_id = $(this).attr('id');
        var btn_id_split = btn_id.split('_');
        var id = btn_id_split[1];

        var currencies = loadCurrencies();

        var selected_exchange = tables_exchanges[id];
        $('#date').val(selected_exchange.date);
        $('#monOri').val(selected_exchange.monOri);
        $('#monFin').val(selected_exchange.monFin);
        $('#valCom').val(selected_exchange.valCom);
        $('#valVen').val(selected_exchange.valVen);

        $('#editModal').modal('show');
    }

    function loadTable() {

        $.ajax({
            method: "GET",
            url: "/Finantial/Settings/GetExchanges"
        })
        .done(function(result) {
            var jsonResult = jQuery.parseJSON(result);
            if (!jQuery.isEmptyObject(jsonResult)) {
                array_exchanges = jsonResult;
                $.each(jsonResult, function(index, value) {
                    var dataUnit = {};
                    var nameDelete = 'btndelete_' + index;
                    var nameEdit = 'btnedit_' + index;
                    dataUnit.edit = "<button type='button' id='" + nameEdit + "' class='btn btn-outline btn-primary'><i class='fa fa-pencil' aria-hidden='true'></i></button>";
                    dataUnit.delete = "<button type='button' id='" + nameDelete + "' class='btn btn-outline btn-danger'><i class='fa fa-trash' aria-hidden='true'></i></button>";
                    dataUnit.date = value.date;
                    dataUnit.monOri = value.monOri;
                    dataUnit.monFin = value.monFin;
                    dataUnit.valCom = value.valCom;
                    dataUnit.valVen = value.valVen;

                    var dataSet = [];
                    dataSet.push(dataUnit);

                    tableExchanges.rows.add(dataSet).draw();
                    $('#'+nameEdit).bind('click', btn_edit_click);
                    $('#'+nameDelete).bind('click', btn_delete_click);
                });
            }
        })
        .fail(function(result) {
            toastr.error(result.statusText, "Mensaje", {
                positionClass: "toast-top-full-width"
            });
        });
    }

    function loadCurrencies() {
        var currencies = [];
        $.ajax({
            method: "GET",
            url: "/Finantial/Settings/GetCurrencies",
            async: false
        })
        .done(function(result) {
            var jsonResult = jQuery.parseJSON(result);
            if (!jQuery.isEmptyObject(jsonResult)) {
                currencies = jsonResult;
            }
        })
        .fail(function(result) {
            toastr.error(result.statusText, "Mensaje", {
                positionClass: "toast-top-full-width"
            });
        });

        return currencies;
    }

    loadTable();

}
    

<div class="row">
    <div class="col-lg-12">
        <div class="ibox float-e-margins">
            <div class="ibox-content">
                <button id="btnAgregar" type="button" class="btn btn btn-primary pull-right"><i class="fa fa-plus" aria-hidden="true"></i> Agregar</button>
                <table class="table table-striped table-bordered table-hover" id="tableExchanges">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="editModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="form-horizontal" id="edit_form" action="/Finantial/Settings/UpdateExchange" method="post">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 id="txtModalTitle" class="modal-title">Editar</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="control-label col-lg-3" for="date">Fecha</label>
                        <div class="col-lg-9">
                            <input class="form-control" id="date" name="date">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-lg-3" for="monOri">Mes origen</label>
                        <div class="col-lg-9">
                            <input class="form-control" id="monOri" name="monOri">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-lg-3" for="monFin">Mes fin</label>
                        <div class="col-lg-9">
                            <input class="form-control" id="monFin" name="monFin" disabled>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-lg-3" for="valCom">Valor de compra</label>
                        <div class="col-lg-9">
                            <input class="form-control" id="valCom" name="valCom">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-lg-3" for="valVen">Valor de venta</label>
                        <div class="col-lg-9">
                            <input class="form-control" id="valVen" name="valVen">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary" id="btnSaveEdit">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>
