
@{
    ViewBag.Title = "Administración de tablas generales del sistema";
    ViewBag.Section = "Configuración";
    Layout = "~/Views/_Layout.cshtml";

}

@section styles_link {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.13/css/dataTables.bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.2.4/css/buttons.dataTables.min.css" />

    @Html.StyleLink("css/bootstrap.min.css");
    @Html.StyleLink("font-awesome/css/font-awesome.css");
    @Html.StyleLink("css/plugins/iCheck/custom.css");
    @Html.StyleLink("css/plugins/steps/jquery.steps.css");
    @Html.StyleLink("css/animate.css");
    @Html.StyleLink("css/style.css");

    @Html.StyleLink("css/plugins/chosen/bootstrap-chosen.css");
    @Html.StyleLink("css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css");

    @Html.StyleLink("css/plugins/sweetalert/sweetalert.css")
    <style type="text/css">
        body {
            padding-right: 0 !important;
        }

        .form-separation {
            margin-bottom: 7px;
            margin-top: 7px;
        }

        .form-label-separation {
            margin-bottom: 10px;
            margin-top: 7px;
        }

        .form-separation-extra {
            margin-bottom: 11px;
        }

        .dataTables_filter {
            width: 50%;
            float: right;
            text-align: right;
        }

        .button-separation {
            margin-left: 12px;
            margin-right: 12px;
        }

        .selected {
            background-color: #acbad4 !important;
        }

        .emulate-label {
            border-left: 0 !important;
            border-right: 0 !important;
            border-top: 0 !important;
            background: #eee !important;
        }

        .labe-sum-underline {
            border-bottom: 3px solid #000000 !important;
        }

        .modal-new-width {
            width: 800px !important;
        }

        .tabIcon:before {
            content: "\f192";
            margin-right: 5px;
        }

        .tabIcon {
            padding: 10px 20px !important;
        }
    </style>
}
@section scripts_link {
    <script src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.13/js/dataTables.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.2.4/js/dataTables.buttons.min.js"></script>

    @Html.JavaScriptLink("js/jquery-2.1.1.js")
    @Html.JavaScriptLink("js/bootstrap.min.js")
    @Html.JavaScriptLink("js/plugins/metisMenu/jquery.metisMenu.js")
    @Html.JavaScriptLink("js/plugins/slimscroll/jquery.slimscroll.min.js")

    <!-- Custom and plugin javascript -->
    @Html.JavaScriptLink("js/inspinia.js")
    @Html.JavaScriptLink("js/plugins/pace/pace.min.js")

    <!-- Steps -->
    @Html.JavaScriptLink("js/plugins/staps/jquery.steps.min.js")

    <!-- Jquery Validate -->
    @Html.JavaScriptLink("js/plugins/validate/jquery.validate.min.js")

    @Html.JavaScriptLink("js/plugins/dataTables/datatables.min.js")
    @Html.JavaScriptLink("js/plugins/iCheck/icheck.min.js")

    @Html.JavaScriptLink("js/plugins/datapicker/bootstrap-datepicker.js")
    @Html.JavaScriptLink("js/plugins/chosen/chosen.jquery.js")
    @Html.JavaScriptLink("js/plugins/typehead/bootstrap3-typeahead.min.js")

    @Html.JavaScriptLink("js/plugins/sweetalert/sweetalert.min.js")
    
    <script>
        function enable_input(btnId) {
            //var btn = $("#" + btnId);
            console.log("#" + btnId);
            console.log("--------------");
            //btn.closest(".key-input").prop("disabled", false);
            //btn.closest(".content-input").prop("disabled", false);
        }
    </script>
}

@section section_script {

    var tableOfTables;

    $(".editTableBtn").click(function(){
        console.log("--------------");
        $(this).closest(".key-input").prop("disabled",false);
        $(this).closest(".content-input").prop("disabled",false);
    });

    $("#btnCaca").click(function(){
        console.log("caca");
    });

    function loadHeaders(codTable){

        $.ajax({
            method: "GET",
            url: "/Finantial/Settings/GetHeads",
            data: {
                codTable: codTable
            },
            async: false
        })
        .done(function(result) {
            var jsonResult = jQuery.parseJSON(result);
            if (!jQuery.isEmptyObject(jsonResult)) {
                tableOfTables = $('#tableOfTables').DataTable({
                    "bPaginate": false,
                    "bLengthChange": false,
                    "bFilter": false,
                    "bInfo": false,
                    "bAutoWidth": false,
                    "paging": false,
                    "columns": [
                         {
                            data : "edit",
                            width: "20%",
                            title: ""
                        },
                         {
                            data : "delete",
                            width: "20%",
                            title: ""
                        },
                        {
                            data : "key",
                            width: "10%",
                            title: "<div style='White-space:pre; padding-left:1%; font-family: monospace !important;'>"+jsonResult[0].TK+"<br />"+jsonResult[0].CK+"</div>"
                        },
                        {
                            data : "content",
                            width: "70%",
                            title: "<div style='White-space:pre; padding-left:1%; font-size:14px;'>"+jsonResult[0].TF+"<br />"+jsonResult[0].CF+"</div>"
                        }
                    ]
                });
            }
        })
        .fail(function(result) {
            toastr.error(result.statusText, "Mensaje", {
            positionClass: "toast-top-full-width"
        });
        });

    }

    function loadData(primaryCode, secondCode){
        var data = {
            primaryCode: primaryCode
        }

        if (secondCode != null){
            data.secondCode = secondCode;
        }
        
        $.ajax({
            method: "GET",
            url: "/Finantial/Settings/GetData",
            data: data,
            async: false
        })
        .done(function(result) {
            var jsonResult = jQuery.parseJSON(result);
            if (!jQuery.isEmptyObject(jsonResult)) {                
                $.each(jsonResult, function (index, value) {
                    var dataUnit = {};
                    var nameDelete='btnedit_' + index;
                    dataUnit.edit="<button type='button' id='"+nameDelete+"'  onclick='enable_input("+nameDelete+")' class='btn btn-outline btn-primary'><i class='fa fa-pencil' aria-hidden='true'></i></button>&nbsp;";
                    dataUnit.delete="<button type='button' id='btnedit_" + index + "' class='btn btn-outline btn-danger'><i class='fa fa-trash' aria-hidden='true'></i></button>&nbsp;";
                    dataUnit.key = "<input class='form-control key-input' disabled style='width:100%' value='"+value.key+"'>";
                    dataUnit.content = "<input class='form-control content-input' disabled style='width:100%' value='"+value.content+"'>";
                    var dataSet = [];
                    dataSet.push(dataUnit);

                    tableOfTables.rows.add(dataSet).draw();
                });
            }
        })
        .fail(function(result) {
            toastr.error(result.statusText, "Mensaje", {
                positionClass: "toast-top-full-width"
            });
        });
    }


    function load_table(primaryCode, secondCode){
        loadHeaders(primaryCode);
        loadData(primaryCode, secondCode);
    }

    function load_table_names(){
        $.ajax({
            method: "GET",
            url: "/Finantial/Settings/GetTTNames"
        })
        .done(function(result) {
            var jsonResult = jQuery.parseJSON(result);
            if (!jQuery.isEmptyObject(jsonResult)) {
                $('#primary_table_id').typeahead({
                    source: jsonResult
                });
            }
        })
        .fail(function(result) {
            toastr.error(result.statusText, "Mensaje", {
                positionClass: "toast-top-full-width"
            });
        });
    }

    function load_table_names_second(){
        $.ajax({
            method: "GET",
            url: "/Finantial/Settings/GetTTNames"
        })
        .done(function(result) {
            var jsonResult = jQuery.parseJSON(result);
            if (!jQuery.isEmptyObject(jsonResult)) {
                $('#second_table_id').typeahead({
                    source: jsonResult
                });
            }
        })
        .fail(function(result) {
            toastr.error(result.statusText, "Mensaje", {
                positionClass: "toast-top-full-width"
            });
        });
    }

    load_table_names();
    load_table_names_second();
    load_table(1,null);

    $('#primary_table_id').change(function(){
        var primary_id = $(this).typeahead("getActive").Value;
        if (primary_id =="999"){
            $("#secondgroup").removeClass("hidden");
            return;
        }else{
             $("#secondgroup").addClass("hidden");
        }

        tableOfTables.clear().draw();
        $('#tableOfTables').dataTable().fnDestroy();

        load_table(primary_id,null);
        
    });

     $('#second_table_id').change(function(){
        var primary_id = $('#primary_table_id').typeahead("getActive").Value;
        var second_id = $(this).typeahead("getActive").Value;

        tableOfTables.clear().draw();
        $('#tableOfTables').dataTable().fnDestroy();

        load_table(primary_id,second_id);

    });
}

<div class="row">
    <div class="col-lg-12">
        <div class="ibox float-e-margins">
            <div class="ibox-content">
                <div id="primarygroup" class="row">
                    <div class="form-group" style="padding-bottom: 50px; padding-top: 20px;">
                        <label class="col-sm-2 control-label">Ingrese Una Tabla</label>
                        <div class="col-sm-10"><input id="primary_table_id" style="width:60%;" type="text" class="form-control"></div>
                    </div>                   
                </div>
                <div id="secondgroup" class="row hidden" style="padding-bottom: 20px;">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Ingrese La tabla que desea editar</label>
                        <div class="col-sm-10"><input id="second_table_id" style="width:60%;" type="text" class="form-control"></div>
                    </div>
                </div>
                <div style="width:100%; height:500px; overflow:scroll;">
                    <table class="table table-striped table-bordered table-hover" id="tableOfTables" style="font-family: monospace !important;">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
